<body>
  <div class="container">
    <h1>CADASTRO MEDIÇÃO FISCAL</h1>
    <div id="contadorMedidores" style="text-align: center; margin-bottom: 1rem; font-weight: bold; color: green;">
      MEDIDORES CADASTRADOS: 0
    </div>
    <form id="cadastroForm">
      <!-- (formulário permanece igual) -->
      <!-- ... seu formulário aqui ... -->
    </form>
    <p class="message" id="mensagem"></p>

    <h2>RELATÓRIO DE CADASTROS</h2>
    <div class="table-container">
      <table id="relatorioTable">
        <!-- (tabela permanece igual) -->
      </table>
    </div>
    <div class="button-group">
      <button id="exportarBtn">EXPORTAR PARA EXCEL</button>
      <button id="limparBtn">LIMPAR LISTA</button>
      <button id="enviarWhatsappBtn" style="display:none;">ENVIAR VIA WHATSAPP</button>
    </div>
  </div>

  <!-- Modal para escolha -->
  <div id="modalExport" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
    <div style="background:#fff; padding:20px; border-radius:8px; max-width:320px; width:90%; box-shadow:0 2px 10px rgba(0,0,0,0.3); text-align:center;">
      <h3>Escolha uma opção</h3>
      <button id="btnDownloadExcel" style="margin:10px; padding:10px 15px; font-weight:bold;">Baixar Arquivo Excel</button>
      <button id="btnEnviarWhatsapp" style="margin:10px; padding:10px 15px; font-weight:bold; background:#25D366; color:#fff; border:none; border-radius:4px;">Enviar via WhatsApp</button>
      <br>
      <button id="btnFecharModal" style="margin-top:15px; padding:6px 12px; background:#ccc; border:none; border-radius:4px;">Cancelar</button>
    </div>
  </div>

  <script>
    // ... Seu código de cadastro e tabela permanece igual, só o que altera é a parte dos botões exportar e modal:

    // Variável global com os cadastros (igual ao seu código)
    let cadastros = [];

    // Já tem carregamento e outras funções, não vou repetir aqui para ficar enxuto.

    // Evento botão Exportar agora só abre a modal
    document.getElementById('exportarBtn').addEventListener('click', function () {
      if (cadastros.length === 0) {
        const msg = document.getElementById('mensagem');
        msg.style.color = 'red';
        msg.textContent = 'NÃO HÁ CADASTROS PARA EXPORTAR!';
        return;
      }
      document.getElementById('modalExport').style.display = 'flex';
    });

    // Fechar modal
    document.getElementById('btnFecharModal').addEventListener('click', function () {
      document.getElementById('modalExport').style.display = 'none';
    });

    // Função para criar e baixar o Excel
    function gerarEbaixarExcel() {
      const ws_data = [
        [
          'MEDIDOR DO CLIENTE',
          'VINCULAR A IN MF',
          'POTÊNCIA DA LÂMPADA (W)',
          'TIPO DE LÂMPADA',
          'QUANTIDADE',
          'MUNICÍPIO',
          'ENDEREÇO',
          'TRAFO',
          'POSTE',
          'NOME DO PROSPECTOR',
          'MATRÍCULA',
          'OBSERVAÇÃO',
        ],
      ];

      cadastros.forEach((item) => {
        ws_data.push([
          item.numero,
          item.instalacao,
          item.potencia,
          item.tipo,
          item.quantidade,
          item.local,
          item.endereco,
          item.trafo,
          item.poste,
          item.prospectorNome,
          item.prospectorMatricula,
          item.observacao,
        ]);
      });

      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet(ws_data);
      XLSX.utils.book_append_sheet(wb, ws, 'MedidoresLampadas');
      XLSX.writeFile(wb, 'cadastros_medidores_lampadas.xlsx');

      document.getElementById('mensagem').style.color = 'green';
      document.getElementById('mensagem').textContent = 'Arquivo Excel exportado com sucesso!';
      document.getElementById('modalExport').style.display = 'none';
    }

    // Função para enviar mensagem via WhatsApp (texto formatado)
    function enviarWhatsapp() {
      let mensagemWhatsapp = `RELATÓRIO DE CADASTROS - MEDIÇÃO FISCAL:\n\n`;
      cadastros.forEach((item, i) => {
        mensagemWhatsapp += `${i + 1}. MEDIDOR: ${item.numero} | INSTALAÇÃO: ${item.instalacao} | MUNICÍPIO: ${item.local} | ENDEREÇO: ${item.endereco}\n`;
        if (item.potencia || item.tipo || item.quantidade) {
          mensagemWhatsapp += `   LÂMPADA: ${item.tipo || '-'} | POTÊNCIA: ${item.potencia || '-'}W | QTD: ${item.quantidade || '-'}\n`;
        }
        mensagemWhatsapp += `   PROSPECTOR: ${item.prospectorNome} (${item.prospectorMatricula})\n`;
        if (item.observacao) mensagemWhatsapp += `   OBS: ${item.observacao}\n`;
        mensagemWhatsapp += '\n';
      });
      mensagemWhatsapp += `TOTAL DE CADASTROS: ${cadastros.length}`;

      const textoCodificado = encodeURIComponent(mensagemWhatsapp);
      const urlWhatsapp = `https://api.whatsapp.com/send?text=${textoCodificado}`;
      window.open(urlWhatsapp, '_blank');

      document.getElementById('mensagem').style.color = 'green';
      document.getElementById('mensagem').textContent = 'RELATÓRIO PREPARADO PARA ENVIO NO WHATSAPP!';
      document.getElementById('modalExport').style.display = 'none';
    }

    // Eventos dos botões da modal
    document.getElementById('btnDownloadExcel').addEventListener('click', gerarEbaixarExcel);
    document.getElementById('btnEnviarWhatsapp').addEventListener('click', enviarWhatsapp);

    // Resto do seu código permanece igual (cadastro, tabela, limpar etc)
  </script>
</body>
